---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import Navigation from '../../../components/Navigation.astro';
import Footer from '../../../components/Footer.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const uniqueTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))];

  return uniqueTags.map(tag => {
    const filteredPosts = allPosts.filter(post => post.data.tags.includes(tag));
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;

// Sort by date
const sortedPosts = posts.sort((a, b) => 
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Get featured post (first/newest post)
const featuredPost = sortedPosts[0];
const sidebarPosts = sortedPosts.slice(1, 3); // Next 2 posts for sidebar
const morePosts = sortedPosts.slice(3); // Remaining posts

// Get all unique tags for the menu
const allBlogPosts = await getCollection('blog');
const allTags = [...new Set(allBlogPosts.flatMap(post => post.data.tags || []))];
const categories = [
  { name: 'All', slug: 'all', active: false },
  ...allTags.map(t => ({ name: t, slug: t, active: t === tag }))
];
---

<Layout title={`${tag} - The Social Media Blog - Markulture`} description={`Posts about ${tag}`}>
  <Navigation />
  
  <main class="min-h-screen bg-white py-12 pt-28">
    <div class="container mx-auto px-4 pt-10">
      
      <!-- Header Section -->
      <div class="mb-12">
        <div class="flex items-start gap-4 mb-8">
          <div class="relative">
            <h1 class="text-5xl md:text-6xl font-bold text-black tracking-tight relative z-10">
              The Social<br/>Media Blog
            </h1>
          </div>
        </div>

        <!-- Categories -->
        <div class="flex flex-wrap gap-3 overflow-x-auto pb-4 scrollbar-hide">
          {categories.map(cat => (
            <a 
              href={cat.slug === 'all' ? '/blog' : `/blog/tag/${cat.slug}`}
              class={`px-6 py-2 rounded-full border text-sm font-medium transition-colors whitespace-nowrap
                ${cat.active 
                  ? 'bg-[#4ADE80] border-[#4ADE80] text-black' 
                  : 'bg-white border-gray-200 text-gray-600 hover:border-gray-400'
                }`}
            >
              {cat.name}
            </a>
          ))}
        </div>
      </div>

      <!-- Main Grid Layout -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-16">
        
        <!-- Left Column: Featured Post (8 cols) -->
        <div class="lg:col-span-8">
          {featuredPost ? (
            <article class="group cursor-pointer h-full flex flex-col">
              <a href={`/blog/${featuredPost.slug}`} class="relative aspect-[4/3] md:aspect-[16/10] overflow-hidden rounded-3xl mb-6 bg-[#5EEAD4] block">
                {featuredPost.data.featuredImage ? (
                  <img 
                    src={featuredPost.data.featuredImage} 
                    alt={featuredPost.data.title}
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center bg-[#5EEAD4] p-8">
                    <h3 class="text-4xl font-bold text-white text-center opacity-50">{featuredPost.data.title}</h3>
                  </div>
                )}
              </a>
              
              <div class="flex flex-col flex-grow">
                <div class="flex items-center gap-4 text-sm font-bold mb-3">
                  <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                  <span class="text-gray-500 uppercase tracking-wider">{featuredPost.data.tags[0] || 'Blog'}</span>
                </div>
                
                <h2 class="text-3xl md:text-4xl font-bold text-black group-hover:text-gray-700 transition-colors mb-3">
                  <a href={`/blog/${featuredPost.slug}`}>
                    {featuredPost.data.title}
                  </a>
                </h2>
              </div>
            </article>
          ) : (
            <div class="p-12 text-center bg-gray-50 rounded-3xl">
              <p class="text-gray-500">No posts available for this tag.</p>
            </div>
          )}
        </div>

        <!-- Right Column: Sidebar (4 cols) -->
        <div class="lg:col-span-4 space-y-8">
          
          <!-- Newsletter Box -->
          <div class="bg-[#F3F4F6] p-8 rounded-3xl">
            <h3 class="text-xl font-bold text-black mb-3">Stay up to date</h3>
            <p class="text-gray-600 text-sm mb-6 leading-relaxed">
              Want to receive the most up to date insights & strategies on everything to do with Social Media, Paid Media & Video Marketing? Sign up to receive our weekly email.
            </p>
            
            <form class="flex flex-col gap-3">
              <div class="relative">
                <input 
                  type="email" 
                  placeholder="Work Email Address *" 
                  class="w-full px-4 py-3 rounded-full border-none focus:ring-2 focus:ring-black text-sm"
                  required
                />
                <button 
                  type="submit"
                  class="absolute right-1 top-1 bottom-1 bg-black text-white px-6 rounded-full text-sm font-bold hover:bg-gray-800 transition-colors"
                >
                  Try It
                </button>
              </div>
            </form>
          </div>

          <!-- Sidebar Posts -->
          <div class="space-y-8">
            {sidebarPosts.map(post => (
              <article class="group cursor-pointer">
                <a href={`/blog/${post.slug}`} class="relative aspect-[16/10] overflow-hidden rounded-2xl mb-4 bg-[#5EEAD4] block">
                  {post.data.featuredImage ? (
                    <img 
                      src={post.data.featuredImage} 
                      alt={post.data.title}
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                    />
                  ) : (
                    <div class="w-full h-full flex items-center justify-center bg-[#5EEAD4] p-4">
                      <h4 class="text-xl font-bold text-white text-center opacity-50">{post.data.title}</h4>
                    </div>
                  )}
                </a>
                
                <div>
                  <h3 class="text-xl font-bold text-black group-hover:text-gray-700 transition-colors mb-2 leading-tight">
                    <a href={`/blog/${post.slug}`}>
                      {post.data.title}
                    </a>
                  </h3>
                  
                  <div class="flex items-center gap-3 text-xs font-bold">
                    <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                    <span class="text-gray-500 uppercase tracking-wider">{post.data.tags[0] || 'Blog'}</span>
                  </div>
                </div>
              </article>
            ))}
          </div>

        </div>
      </div>

      <!-- More Posts Grid (Optional) -->
      {morePosts.length > 0 && (
        <div class="border-t pt-12">
          <h3 class="text-2xl font-bold mb-8">More Articles</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {morePosts.map(post => (
              <article class="group cursor-pointer">
                <a href={`/blog/${post.slug}`} class="relative aspect-[16/10] overflow-hidden rounded-2xl mb-4 bg-gray-100 block">
                  {post.data.featuredImage && (
                    <img 
                      src={post.data.featuredImage} 
                      alt={post.data.title}
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                    />
                  )}
                </a>
                <h3 class="text-xl font-bold text-black group-hover:text-gray-700 transition-colors mb-2">
                  <a href={`/blog/${post.slug}`}>
                    {post.data.title}
                  </a>
                </h3>
                <div class="flex items-center gap-3 text-xs font-bold">
                  <span class="text-black">5 min read</span>
                  <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                  <span class="text-gray-500 uppercase tracking-wider">{post.data.tags[0] || 'Blog'}</span>
                </div>
              </article>
            ))}
          </div>
        </div>
      )}

    </div>
  </main>
  
  <Footer />
</Layout>