<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Content Manager</title>
  <style>
    /* Add some basic styling for the preview */
    .cms-preview-pane {
      font-family: system-ui, -apple-system, sans-serif;
    }
    .note-frame {
      background-color: #fff;
    }
    
    /* GrapesJS specific styles for CMS */
    .grapesjs-container {
      border: 1px solid #ddd !important;
      border-radius: 4px !important;
    }
    
    /* Make sure GrapesJS modal dialogs appear above CMS modals */
    .gjs-mdl-container {
      z-index: 999999 !important;
    }
    
    /* Better styling for the loading state */
    .grapesjs-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      font-size: 16px;
      color: #666;
    }
    
    /* Custom widget styling */
    .widget-control {
      margin-bottom: 1rem;
    }
    
    .widget-control label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #333;
    }
    
    /* GrapesJS Blocks styling */
    #blocks .gjs-block {
      width: calc(50% - 5px) !important;
      margin: 2px !important;
      padding: 8px !important;
      background: #fff !important;
      border: 1px solid #ddd !important;
      border-radius: 4px !important;
      cursor: pointer !important;
      text-align: center !important;
      font-size: 12px !important;
      transition: all 0.2s ease !important;
    }
    
    #blocks .gjs-block:hover {
      border-color: #007bff !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }
    
    #blocks .gjs-block i {
      display: block !important;
      font-size: 18px !important;
      margin-bottom: 4px !important;
      color: #007bff !important;
    }
    
    /* Better preview styling */
    .grapesjs-preview {
      font-family: system-ui, -apple-system, sans-serif;
      line-height: 1.6;
    }
    
    .grapesjs-preview img {
      max-width: 100%;
      height: auto;
    }
    
    /* Responsive design for the editor */
    @media (max-width: 768px) {
      .grapesjs-container {
        height: 400px !important;
      }
    }
    
    /* Make Pages collection container wider - FORCE OVERRIDE */
    .cms-editor-wrapper {
      max-width: none !important;
    }
    
    /* Target ALL possible DecapCMS container classes with high specificity */
    .cms-editor-wrapper,
    .cms-editor-main,
    .cms-editor-control,
    .cms-editor-form,
    .cms-collection-editor,
    .cms-single-entry-editor,
    .cms-workflow-editor,
    div[class*="Editor"],
    div[class*="editor"],
    .cms-app > div,
    .cms-app main,
    .cms-app article {
      max-width: none !important;
      width: 100% !important;
    }
    
    /* Specifically target Pages collection for wider layout with maximum specificity */
    body .cms-app [data-collection="pages"] .cms-editor-wrapper,
    body .cms-app [data-collection="pages"] .cms-editor-control,
    body .cms-app [data-collection="pages"] .cms-editor-main,
    body .cms-app [data-collection="pages"] .cms-editor-form,
    body .cms-app [data-collection="pages"] .cms-collection-editor,
    body .cms-app [data-collection="pages"] div[class*="Editor"],
    body .cms-app [data-collection="pages"] div[class*="editor"] {
      max-width: none !important;
      width: 98vw !important;
      margin: 0 auto !important;
      padding: 0 1vw !important;
    }
    
    /* Force override DecapCMS default container styles */
    html body .cms-app * {
      max-width: none !important;
    }
    
    /* Make the GrapesJS widget take full available width in Pages */
    body .cms-app [data-collection="pages"] .grapesjs-container,
    body .cms-app [data-collection="pages"] .widget-control,
    body .cms-app [data-collection="pages"] .widget-grapesjs {
      width: 100% !important;
      max-width: none !important;
      box-sizing: border-box !important;
    }

    .css-c9zyab-ControlPaneContainer {
      max-width: 1024px !important;
    }
    
    /* Override any remaining width constraints with nuclear option */
    [data-collection="pages"] * {
      max-width: 1024px !important;
    }
  </style>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    window.CMS_MANUAL_INIT = true;
  </script>
</head>
<body>
  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <!-- Load js-yaml library for YAML parsing -->
  <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  
  <!-- Include our custom widgets BEFORE CMS.init() -->
  <script src="./preview.js"></script>
  <script src="./summernote-enhancement.js"></script>
  <script src="./grapejs-widget.js"></script>
  <script src="./link-opener-widget.js"></script>
  <script src="./google-snippet-widget.js"></script>

  <script>
    CMS.init({
      config: {
        backend: {
          name: "git-gateway",
          branch: "main",
          identity_url: "https://makulture.netlify.app/.netlify/identity",
          gateway_url: "https://makulture.netlify.app/.netlify/git",
          commit_messages: {
            create: "Create {{collection}} \"{{slug}}\" [skip netlify]",
            update: "Update {{collection}} \"{{slug}}\" [skip netlify]",
            delete: "Delete {{collection}} \"{{slug}}\" [skip netlify]",
            uploadMedia: "Upload \"{{path}}\" [skip netlify]",
            deleteMedia: "Delete \"{{path}}\" [skip netlify]"
          }
        },
        local_backend: true,
        locale: 'vi',
        media_folder: "public/images/uploads",
        public_folder: "/images/uploads",
        collections: [
          {
            name: "blog",
            label: "Blog",
            folder: "src/content/blog",
            create: true,
            slug: "{{year}}-{{month}}-{{day}}-{{slug}}",
            summary: "{{title}} - {{date | date('DD/MM/YYYY')}}",
            sortable_fields: ['date', 'title', 'commit_date'],
            view_groups: [
              {
                label: "Năm",
                field: "date",
                pattern: "\\d{4}"
              },
              {
                label: "Thẻ",
                field: "tags"
              }
            ],
            fields: [
              { label: "Layout", name: "layout", widget: "hidden", default: "blog" },
              { label: "Tiêu đề", name: "title", widget: "string" },
              { label: "Ngày xuất bản", name: "date", widget: "datetime" },
              { label: "Hình ảnh nổi bật", name: "featuredImage", widget: "image", required: false },
              { label: "Tóm tắt", name: "excerpt", widget: "text" },
              { label: "Nội dung", name: "body", widget: "summernote" },
              { label: "Thẻ", name: "tags", widget: "list", default: ["blog"] }
            ]
          },
          {
            name: "pages",
            label: "Trang",
            editor: {
              preview: false,
              frame: true,
              size: "large"
            },
            files: [
              {
                label: "Trang Giới Thiệu",
                name: "about",
                file: "src/content/pages/about.md",
                fields: [
                  { label: "Layout", name: "layout", widget: "hidden", default: "page" },
                  { label: "Tiêu đề", name: "title", widget: "string" },
                  { label: "Mô tả", name: "description", widget: "text", required: false },
                  { label: "Xem trước SEO", name: "seoPreview", widget: "google-snippet-preview", required: false },
                  { label: "Hành động trang trực tiếp", name: "livePageActions", widget: "live-page-opener", required: false },
                  {
                    label: "Nội dung (Trình soạn thảo trực quan)",
                    name: "bodyVisual",
                    widget: "grapesjs",
                    required: false
                  }
                ]
              },
              {
                label: "Trang Liên Hệ",
                name: "contact",
                file: "src/content/pages/contact.md",
                fields: [
                  { label: "Layout", name: "layout", widget: "hidden", default: "page" },
                  { label: "Tiêu đề", name: "title", widget: "string" },
                  { label: "Mô tả", name: "description", widget: "text", required: false },
                  { label: "Xem trước SEO", name: "seoPreview", widget: "google-snippet-preview", required: false },
                  { label: "Hành động trang trực tiếp", name: "livePageActions", widget: "live-page-opener", required: false },
                  {
                    label: "Nội dung (Trình soạn thảo trực quan)",
                    name: "bodyVisual",
                    widget: "grapesjs",
                    required: false
                  }
                ]
              }
            ]
          },
          {
            name: "landing",
            label: "Trang Đích",
            folder: "src/content/landing",
            create: true,
            slug: "{{slug}}",
            editor: {
              preview: false,
              frame: true,
              size: "large"
            },
            fields: [
              { label: "Tiêu đề", name: "title", widget: "string" },
              { label: "Mô tả", name: "description", widget: "text" },
              { label: "Đường dẫn", name: "slug", widget: "string" },
              { label: "Xem trước SEO", name: "seoPreview", widget: "google-snippet-preview", required: false },
              {
                label: "Nội dung (Trình soạn thảo trực quan)",
                name: "bodyVisual",
                widget: "grapesjs",
                required: false
              },
              { label: "Hành động trang trực tiếp", name: "livePageActions", widget: "live-page-opener", required: false }
            ]
          },
          {
            name: "settings",
            label: "Cài Đặt",
            files: [
              {
                label: "Cài Đặt Chung",
                name: "general",
                file: "src/content/settings/general.json",
                editor: {
                  preview: false
                },
                fields: [
                  {
                    label: "Trang chủ",
                    name: "homepage",
                    widget: "relation",
                    collection: "landing",
                    search_fields: ["title", "slug"],
                    value_field: "slug",
                    display_fields: ["title"],
                    required: false,
                    hint: "Chọn landing page sẽ được hiển thị làm trang chủ"
                  }
                ]
              }
            ]
          }
        ]
      }
    });
  </script>
  
  <!-- Load Vietnamese translation -->
  <script>
    // Load Vietnamese locale
    fetch('./vi.yml')
      .then(response => response.text())
      .then(data => {
        // Parse YAML and register the locale
        const yamlData = jsyaml.load(data);
        if (window.CMS && yamlData.vi) {
          CMS.registerLocale('vi', yamlData.vi);
        }
      })
      .catch(error => console.log('Vietnamese locale loading failed:', error));
  </script>
</body>
</html>
